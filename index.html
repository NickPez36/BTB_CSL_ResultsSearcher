<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canoe Slalom Results Searcher</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .tab-button.active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details > summary::before {
            content: '+';
            margin-right: 0.5rem;
        }
        details[open] > summary::before {
            content: '-';
        }
        .cslx-toggle-btn.active {
            background-color: #3b82f6;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8 flex items-center justify-between">
            <img src="https://raw.githubusercontent.com/NickPez36/BTB_CSL_ResultsSearcher/main/assets/Paddle%20Aus%20Logo.png" alt="Paddle Australia Logo" class="h-12 md:h-16">
            <div class="text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Canoe Slalom Results Searcher</h1>
                <p class="text-gray-600 mt-2">Historical results at your fingertips for media releases.</p>
            </div>
            <img src="https://raw.githubusercontent.com/NickPez36/BTB_CSL_ResultsSearcher/main/assets/BTB_Logo.png" alt="Behind the Bib Logo" class="h-12 md:h-16">
        </header>

        <!-- Tab Controls -->
        <div class="mb-6 border-b border-gray-300">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button id="athleteTabButton" class="tab-button active py-4 px-1 text-sm font-medium text-gray-500 hover:text-blue-600" onclick="switchTab('athlete')">Athlete Search</button>
                <button id="nationTabButton" class="tab-button py-4 px-1 text-sm font-medium text-gray-500 hover:text-blue-600" onclick="switchTab('nation')">Nation Search</button>
                <button id="cslxTabButton" class="tab-button py-4 px-1 text-sm font-medium text-gray-500 hover:text-blue-600" onclick="switchTab('cslx')">CSLX Commentary Stats</button>
            </nav>
        </div>
        
        <main>
            <!-- Loading Indicator -->
            <div id="loader" class="flex flex-col items-center justify-center h-64">
                <div class="loader"></div>
                <p class="mt-4 text-gray-600">Fetching results data...</p>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
                <strong class="font-bold">Error:</strong>
                <span class="block sm:inline" id="errorText"></span>
            </div>

            <!-- Athlete Search Tab Content -->
            <div id="athleteTab" class="hidden space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 p-6 bg-white rounded-lg shadow-md">
                    <div class="flex flex-col">
                        <label for="athleteClass" class="mb-2 font-semibold text-gray-700">Class:</label>
                        <select id="athleteClass" class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></select>
                    </div>
                     <div class="flex flex-col">
                        <label for="athleteNation" class="mb-2 font-semibold text-gray-700">Nation:</label>
                        <select id="athleteNation" class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></select>
                    </div>
                    <div class="flex flex-col">
                        <label for="athleteNameInput" class="mb-2 font-semibold text-gray-700">Athlete Name:</label>
                        <div class="relative">
                            <input type="text" id="athleteNameInput" placeholder="Type to search..." class="p-2 border border-gray-300 rounded-md w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <div id="athleteNameDropdown" class="absolute z-10 w-full bg-white border rounded-md mt-1 hidden max-h-60 overflow-y-auto shadow-lg"></div>
                        </div>
                    </div>
                    <div class="flex items-end">
                        <button id="searchAthlete" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">Search Athlete</button>
                    </div>
                </div>
                <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md" role="alert">
                    <p class="font-bold">Data Scope</p>
                    <p>Canoe Slalom data is complete from 2013 - 2025, CSLX data is complete from 2022 - 2025. Olympics data is excluded due to the limitations in athlete eligibility to compete at the Olympic Games.</p>
                </div>
                <div id="athleteResults" class="hidden"></div>
            </div>

            <!-- Nation Search Tab Content -->
            <div id="nationTab" class="hidden space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-6 bg-white rounded-lg shadow-md">
                    <div class="flex flex-col">
                        <label for="nationClass" class="mb-2 font-semibold text-gray-700">Class:</label>
                        <select id="nationClass" class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></select>
                    </div>
                    <div class="flex flex-col">
                        <label for="nationSelect" class="mb-2 font-semibold text-gray-700">Nation:</label>
                        <select id="nationSelect" class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></select>
                    </div>
                    <div class="flex items-end">
                        <button id="searchNation" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">Search Nation</button>
                    </div>
                </div>
                <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md" role="alert">
                    <p class="font-bold">Data Scope</p>
                    <p>Canoe Slalom data is complete from 2013 - 2025, CSLX data is complete from 2022 - 2025. Olympics data is excluded due to the limitations in athlete eligibility to compete at the Olympic Games.</p>
                </div>
                <div id="nationResults" class="hidden"></div>
            </div>
            
            <!-- CSLX Commentary Stats Tab -->
            <div id="cslxTab" class="hidden space-y-6">
                <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md" role="alert">
                    <p class="font-bold">Data Scope</p>
                    <p>Canoe Slalom data is complete from 2013 - 2025, CSLX data is complete from 2022 - 2025. Olympics data is excluded due to the limitations in athlete eligibility to compete at the Olympic Games.</p>
                </div>
                <div class="p-6 bg-white rounded-lg shadow-md">
                    <div class="flex justify-center mb-6">
                        <div class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" id="mcslxBtn" class="cslx-toggle-btn active py-2 px-4 text-sm font-medium text-gray-900 bg-white rounded-l-lg border border-gray-200 hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-blue-500">
                                MCSLX
                            </button>
                            <button type="button" id="wcslxBtn" class="cslx-toggle-btn py-2 px-4 text-sm font-medium text-gray-900 bg-white rounded-r-md border border-gray-200 hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-blue-500">
                                WCSLX
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- Athlete Columns will be generated here -->
                        <div id="cslxAthlete1" class="cslx-athlete-column"></div>
                        <div id="cslxAthlete2" class="cslx-athlete-column"></div>
                        <div id="cslxAthlete3" class="cslx-athlete-column"></div>
                        <div id="cslxAthlete4" class="cslx-athlete-column"></div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const dataUrl = 'https://raw.githubusercontent.com/NickPez36/BTB_CSL_ResultsSearcher/main/data/canoe_slalom_overall_ranks.csv';
        let fullData = [];

        // UI Elements
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        
        const athleteTab = document.getElementById('athleteTab');
        const nationTab = document.getElementById('nationTab');
        const cslxTab = document.getElementById('cslxTab');

        const athleteTabButton = document.getElementById('athleteTabButton');
        const nationTabButton = document.getElementById('nationTabButton');
        const cslxTabButton = document.getElementById('cslxTabButton');
        
        const athleteClassSelect = document.getElementById('athleteClass');
        const athleteNationSelect = document.getElementById('athleteNation');
        const athleteNameInput = document.getElementById('athleteNameInput');
        const athleteNameDropdown = document.getElementById('athleteNameDropdown');
        const searchAthleteBtn = document.getElementById('searchAthlete');
        const athleteResultsContainer = document.getElementById('athleteResults');

        const nationClassSelect = document.getElementById('nationClass');
        const nationSelect = document.getElementById('nationSelect');
        const searchNationBtn = document.getElementById('searchNation');
        const nationResultsContainer = document.getElementById('nationResults');

        // CSLX UI Elements
        const mcslxBtn = document.getElementById('mcslxBtn');
        const wcslxBtn = document.getElementById('wcslxBtn');
        const cslxAthleteColumns = document.querySelectorAll('.cslx-athlete-column');
        let selectedCslxClass = 'MCSLX';
        let mainAthleteList = [];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            searchAthleteBtn.addEventListener('click', searchAthlete);
            searchNationBtn.addEventListener('click', searchNation);
            athleteClassSelect.addEventListener('change', updateAthleteNameFilter);
            athleteNationSelect.addEventListener('change', updateAthleteNameFilter);

            mcslxBtn.addEventListener('click', () => setCslxClass('MCSLX'));
            wcslxBtn.addEventListener('click', () => setCslxClass('WCSLX'));
            
            // Event listeners for main athlete search input
            athleteNameInput.addEventListener('input', () => renderAthleteDropdown(athleteNameInput.value));
            athleteNameInput.addEventListener('focus', () => renderAthleteDropdown(athleteNameInput.value));
            athleteNameDropdown.addEventListener('click', (e) => {
                if (e.target && e.target.dataset.name) {
                    athleteNameInput.value = e.target.dataset.name;
                    athleteNameDropdown.classList.add('hidden');
                }
            });
        });

        // Global click listener to hide dropdowns
        document.addEventListener('click', (e) => {
            // Main athlete search dropdown
            if (!athleteNameInput.contains(e.target) && !athleteNameDropdown.contains(e.target)) {
                athleteNameDropdown.classList.add('hidden');
            }
            // CSLX dropdowns
            cslxAthleteColumns.forEach((col, i) => {
                const input = col.querySelector(`#cslx-athlete-input-${i+1}`);
                const dropdown = col.querySelector(`#cslx-athlete-dropdown-${i+1}`);
                if (input && dropdown && !input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });
        });


        async function fetchData() {
            document.querySelectorAll('main > div:not(#loader):not(#errorMessage)').forEach(el => el.classList.add('hidden'));
            loader.classList.remove('hidden');
            try {
                const response = await fetch(dataUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const csvText = await response.text();
                fullData = parseCSV(csvText);
                populateFilters();
                setupCslxTab();
                switchTab('athlete'); 
            } catch (e) {
                console.error("Failed to fetch or parse data:", e);
                showError("Could not load results data. Please check the data source and your internet connection.");
            } finally {
                loader.classList.add('hidden');
            }
        }
        
        function toProperCase(str) {
            if (!str) return '';
            return str.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
        }

        function parseCSV(text) {
            const lines = text.trim().replace(/\r/g, '').split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;
                const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if (values.length !== headers.length) {
                    console.warn(`Malformed CSV row #${i + 1}: Skipping.`, line);
                    continue;
                }
                const obj = {};
                headers.forEach((header, index) => {
                    let value = (values[index] || '').trim().replace(/^"|"$/g, '');
                    if (header === "Overall Rank" || header === "Year") obj[header] = parseInt(value, 10) || null;
                    else if (header === 'Athlete Name') obj[header] = toProperCase(value);
                    else obj[header] = value;
                });
                data.push(obj);
            }
            return data.filter(row => row.Year);
        }

        function populateFilters() {
            const classes = [...new Set(fullData.map(row => row.Class))].sort();
            const nations = [...new Set(fullData.map(row => row.Nation))].sort();
            const classOptions = classes.map(c => `<option value="${c}">${c}</option>`).join('');
            athleteClassSelect.innerHTML = classOptions;
            nationClassSelect.innerHTML = classOptions;
            const nationOptions = nations.map(n => `<option value="${n}">${n}</option>`).join('');
            nationSelect.innerHTML = nationOptions;
            athleteNationSelect.innerHTML = nationOptions;
            updateAthleteNameFilter();
        }

        function updateAthleteNameFilter() {
            const selectedClass = athleteClassSelect.value;
            const selectedNation = athleteNationSelect.value;
            mainAthleteList = [...new Set(fullData.filter(row => row.Class === selectedClass && row.Nation === selectedNation && row['Athlete Name']).map(row => row['Athlete Name']))].sort();
            athleteNameInput.value = ''; // Clear input on filter change
            athleteNameDropdown.innerHTML = '';
            athleteNameDropdown.classList.add('hidden');
        }
        
        function renderAthleteDropdown(searchTerm) {
            const filteredAthletes = mainAthleteList.filter(athlete =>
                athlete.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (filteredAthletes.length === 0 || searchTerm.trim() === '') {
                 athleteNameDropdown.innerHTML = filteredAthletes.map(athlete => `<div class="p-2 hover:bg-gray-100 cursor-pointer" data-name="${athlete}">${athlete}</div>`).join('');
            }
            if (filteredAthletes.length > 0) {
                 athleteNameDropdown.classList.remove('hidden');
            } else {
                 athleteNameDropdown.classList.add('hidden');
            }
        }
        
        function switchTab(tabName) {
            const tabs = { athlete: athleteTab, nation: nationTab, cslx: cslxTab };
            const buttons = { athlete: athleteTabButton, nation: nationTabButton, cslx: cslxTabButton };
            Object.values(tabs).forEach(tab => tab.classList.add('hidden'));
            Object.values(buttons).forEach(btn => btn.classList.remove('active'));
            tabs[tabName].classList.remove('hidden');
            buttons[tabName].classList.add('active');
        }

        function searchAthlete() {
            const athleteName = athleteNameInput.value;
            if (!athleteName) {
                showError("Please select an athlete.", athleteResultsContainer);
                return;
            }
            const selectedClass = athleteClassSelect.value;
            const athleteClassData = fullData.filter(row => row['Athlete Name'] === athleteName && row.Class === selectedClass);
            const uniqueResults = {};
            athleteClassData.forEach(row => {
                const key = `${row.Year}-${row.Competition}-${row.Location}`;
                if (!uniqueResults[key]) uniqueResults[key] = row;
            });
            const results = Object.values(uniqueResults).sort((a, b) => b.Year - a.Year);
            displayAthleteResults(results, athleteName, selectedClass);
        }

        function displayAthleteResults(results, name, className) {
            athleteResultsContainer.classList.remove('hidden');
            if (results.length === 0) {
                athleteResultsContainer.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-2xl font-bold mb-2">No Results Found</h2><p>No results found for ${name} in the ${className} class.</p></div>`;
                return;
            }
            const summary = calculateSummary(results);
            const summaryHTML = createSummaryHTML(`${name} - ${className} Summary`, summary);
            const tableHTML = createCollapsibleResults(results, false);
            athleteResultsContainer.innerHTML = summaryHTML + tableHTML;
        }

        function searchNation() {
            const selectedClass = nationClassSelect.value;
            const selectedNation = nationSelect.value;
            const nationClassData = fullData.filter(row => row.Nation === selectedNation && row.Class === selectedClass);
            const bestResultsPerCompetition = {};
            nationClassData.forEach(row => {
                const key = `${row.Year}-${row.Competition}-${row.Location}`;
                const existingBest = bestResultsPerCompetition[key];
                if (!existingBest || (row['Overall Rank'] && row['Overall Rank'] < existingBest['Overall Rank'])) {
                    bestResultsPerCompetition[key] = row;
                }
            });
            const results = Object.values(bestResultsPerCompetition).sort((a, b) => b.Year - a.Year);
            displayNationResults(results, selectedNation, selectedClass);
        }
        
        function displayNationResults(results, nation, className) {
            nationResultsContainer.classList.remove('hidden');
            if (results.length === 0) {
                nationResultsContainer.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-2xl font-bold mb-2">No Results Found</h2><p>No results found for ${nation} in the ${className} class.</p></div>`;
                return;
            }
            const summary = calculateSummary(results);
            const summaryHTML = createSummaryHTML(`${nation} - ${className} Summary (Best National Results)`, summary);
            const tableHTML = createCollapsibleResults(results, true);
            nationResultsContainer.innerHTML = summaryHTML + tableHTML;
        }
        
        function calculateSummary(results) {
             const getResultInfo = (result) => result && result['Overall Rank'] ? { rank: result['Overall Rank'], details: `${result.Competition} in ${result.Location}, ${result.Year}` } : { rank: 'N/A', details: 'Not Available' };
             const bestResult = results.reduce((best, current) => {
                if (!current || !current['Overall Rank']) return best;
                if (!best || current['Overall Rank'] < best['Overall Rank'] || (current['Overall Rank'] === best['Overall Rank'] && current.Year > best.Year)) return current;
                return best;
            }, null);
            return {
                best: getResultInfo(bestResult),
                lastMedal: getResultInfo(results.find(r => r['Overall Rank'] <= 3)),
                lastTop5: getResultInfo(results.find(r => r['Overall Rank'] <= 5)),
                lastTop10: getResultInfo(results.find(r => r['Overall Rank'] <= 10)),
            };
        }
        
        function createSummaryHTML(title, summary) {
            return `<div class="bg-white p-6 rounded-lg shadow-md mb-6"><h2 class="text-2xl font-bold mb-4 text-gray-800">${title}</h2><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-center">${createSummaryCard('Best Result', summary.best.rank, summary.best.details)}${createSummaryCard('Last Medal', summary.lastMedal.rank, summary.lastMedal.details)}${createSummaryCard('Last Top 5', summary.lastTop5.rank, summary.lastTop5.details)}${createSummaryCard('Last Top 10', summary.lastTop10.rank, summary.lastTop10.details)}</div></div>`;
        }

        function createSummaryCard(title, rank, details) {
            const rankColor = rank <= 3 ? 'text-green-500' : (rank <=10 ? 'text-yellow-500' : 'text-gray-700');
            return `<div class="bg-gray-50 p-4 rounded-lg border border-gray-200"><h4 class="font-semibold text-gray-600 text-sm">${title}</h4><p class="text-3xl font-bold ${rankColor}">${rank || 'N/A'}</p><p class="text-xs text-gray-500">${details}</p></div>`;
        }

        function createCollapsibleResults(results, isNationSearch = false) {
            if (results.length === 0) return '';
            const resultsByYear = results.reduce((acc, row) => { (acc[row.Year] = acc[row.Year] || []).push(row); return acc; }, {});
            const years = Object.keys(resultsByYear).sort((a, b) => b - a);
            let html = years.map((year, index) => {
                const yearResults = resultsByYear[year];
                const headers = isNationSearch ? ['Competition', 'Location', 'Best Rank', 'Athlete'] : ['Competition', 'Location', 'Overall Rank'];
                const rows = yearResults.map(row => `<tr class="border-b last:border-b-0 hover:bg-gray-50"><td class="py-3 px-4">${row.Competition}</td><td class="py-3 px-4">${row.Location}</td><td class="py-3 px-4 font-semibold">${row['Overall Rank'] || 'N/A'}</td>${isNationSearch ? `<td class="py-3 px-4">${row['Athlete Name']}</td>` : ''}</tr>`).join('');
                return `<details class="bg-white p-4 rounded-lg shadow-sm mb-2" ${index === 0 ? 'open' : ''}><summary class="font-bold text-lg cursor-pointer">${year} Results</summary><div class="overflow-x-auto"><table class="w-full text-left mt-2 text-sm"><thead class="bg-gray-100"><tr>${headers.map(h => `<th class="py-2 px-4 font-semibold">${h}</th>`).join('')}</tr></thead><tbody>${rows}</tbody></table></div></details>`;
            }).join('');
            return `<div class="mt-6"><h3 class="text-xl font-bold mb-4">Detailed Historical Results</h3>${html}</div>`;
        }
        
        // --- CSLX Commentary Stats Logic ---
        function setCslxClass(className) {
            selectedCslxClass = className;
            mcslxBtn.classList.toggle('active', className === 'MCSLX');
            wcslxBtn.classList.toggle('active', className === 'WCSLX');
            setupCslxTab();
        }

        function setupCslxTab() {
            const athletes = [...new Set(fullData.filter(row => row.Class === selectedCslxClass && row['Athlete Name']).map(row => row['Athlete Name']))].sort();
            
            cslxAthleteColumns.forEach((col, i) => {
                const colIndex = i + 1;
                col.innerHTML = `
                    <div class="flex flex-col space-y-4 p-4 border rounded-lg bg-gray-50 h-full">
                        <label for="cslx-athlete-input-${colIndex}" class="font-semibold text-gray-700">Athlete ${colIndex}:</label>
                         <div class="relative">
                            <input type="text" id="cslx-athlete-input-${colIndex}" placeholder="Type to search..." class="p-2 border border-gray-300 rounded-md w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <div id="cslx-athlete-dropdown-${colIndex}" class="absolute z-10 w-full bg-white border rounded-md mt-1 hidden max-h-48 overflow-y-auto shadow-lg"></div>
                        </div>
                        <div id="cslx-stats-${colIndex}" class="stats-container space-y-3 text-sm"></div>
                    </div>
                `;
            });

            cslxAthleteColumns.forEach((col, i) => {
                const colIndex = i + 1;
                const input = col.querySelector(`#cslx-athlete-input-${colIndex}`);
                const dropdown = col.querySelector(`#cslx-athlete-dropdown-${colIndex}`);

                input.addEventListener('input', () => renderCslxDropdown(input, dropdown, athletes));
                input.addEventListener('focus', () => renderCslxDropdown(input, dropdown, athletes));
                
                dropdown.addEventListener('click', (e) => {
                    if (e.target && e.target.dataset.name) {
                        input.value = e.target.dataset.name;
                        dropdown.classList.add('hidden');
                        displayCslxStats(colIndex, input.value);
                    }
                });
            });
        }

        function renderCslxDropdown(input, dropdown, athleteList) {
            const searchTerm = input.value.toLowerCase();
            const filteredAthletes = athleteList.filter(athlete =>
                athlete.toLowerCase().includes(searchTerm)
            );

            dropdown.innerHTML = filteredAthletes.map(athlete =>
                `<div class="p-2 text-sm hover:bg-gray-100 cursor-pointer" data-name="${athlete}">${athlete}</div>`
            ).join('');

            if (filteredAthletes.length > 0) {
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        }


        function getCompetitionOrder(compName) {
            if (!compName) return 0;
            if (compName.toLowerCase().includes('world cup')) {
                const num = compName.match(/\d+/);
                return num ? parseInt(num[0], 10) : 0;
            }
            if (compName.toLowerCase().includes('world championship')) return 10; // Make champs highest priority for sorting
            return 0;
        }

        function displayCslxStats(colIndex, athleteName) {
            const statsContainer = document.getElementById(`cslx-stats-${colIndex}`);
            if (!athleteName) {
                statsContainer.innerHTML = '';
                return;
            }
            
            // Get CSLX-specific results, sorted for recent races
            const cslxResults = fullData
                .filter(row => row['Athlete Name'] === athleteName && row.Class === selectedCslxClass && row['Overall Rank'])
                .sort((a, b) => {
                    if (a.Year !== b.Year) return b.Year - a.Year;
                    return getCompetitionOrder(b.Competition) - getCompetitionOrder(a.Competition);
                });

            if (cslxResults.length === 0) {
                statsContainer.innerHTML = '<p class="text-gray-500">No CSLX results found.</p>';
                return;
            }

            // --- Medal Calculations (Kayak Cross only) ---
            // For World Champs, count medals from Overall Rank directly
            const wcMedalResults = cslxResults.filter(r => 
                r.Competition && r.Competition.toLowerCase().includes('world championship') && 
                r['Overall Rank'] <= 3
            );
            const wcGold = wcMedalResults.filter(r => r['Overall Rank'] === 1).length;
            const wcSilver = wcMedalResults.filter(r => r['Overall Rank'] === 2).length;
            const wcBronze = wcMedalResults.filter(r => r['Overall Rank'] === 3).length;

            // For World Cups, medals must come from the 'Brackets' phase
            const worldCupMedalResults = cslxResults.filter(r =>
                r.Competition && r.Competition.toLowerCase().includes('world cup') &&
                r.Phase === 'Brackets' &&
                r['Overall Rank'] <= 3
            );
            
            const totalMedals = wcMedalResults.length + worldCupMedalResults.length;

            // --- CSLX-Specific Stats ---
            const bestResult = cslxResults.reduce((best, current) => current['Overall Rank'] < best['Overall Rank'] ? current : best);
            const last5races = cslxResults.slice(0, 5);
            const avgRank = last5races.length > 0 ? last5races.reduce((sum, r) => sum + r['Overall Rank'], 0) / last5races.length : 0;

            statsContainer.innerHTML = `
                <div>
                    <h4 class="font-bold">Total CSLX Medals:</h4>
                    <p>${totalMedals}</p>
                </div>
                <div>
                    <h4 class="font-bold">World Champs Medals:</h4>
                    <p class="text-xs flex items-center space-x-2">
                        <span title="Gold">ðŸ¥‡ ${wcGold}</span>
                        <span title="Silver">ðŸ¥ˆ ${wcSilver}</span>
                        <span title="Bronze">ðŸ¥‰ ${wcBronze}</span>
                    </p>
                </div>
                <hr class="my-2 border-gray-300">
                <div>
                    <h4 class="font-bold">Best CSLX Result:</h4>
                    <p>${bestResult['Overall Rank']} <span class="text-gray-500">(${bestResult.Competition}, ${bestResult.Year})</span></p>
                </div>
                <div>
                    <h4 class="font-bold">Avg. CSLX Rank (Last ${last5races.length}):</h4>
                    <p>${last5races.length > 0 ? avgRank.toFixed(1) : 'N/A'}</p>
                </div>
                <div>
                    <h4 class="font-bold">Last ${last5races.length} CSLX Races:</h4>
                    <ul class="list-disc list-inside text-gray-600">
                        ${last5races.map(r => `<li>${r['Overall Rank']} <span class="text-xs">(${r.Competition.replace('World Cup', 'WC')}, ${r.Year})</span></li>`).join('')}
                    </ul>
                </div>
            `;
        }

        function showError(message, container = null) {
            if (container) {
                container.classList.remove('hidden');
                container.innerHTML = `<div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-lg" role="alert">${message}</div>`;
            } else {
                 errorText.textContent = message;
                 errorMessage.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>

